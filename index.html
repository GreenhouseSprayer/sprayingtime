<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spray Plan</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    @media print {
      button, input[type="file"] {
        display: none !important;
      }
      body {
        margin: 0;
        padding: 0;
        font-size: 10px;
      }
      table {
        page-break-inside: avoid;
      }
    }

    body {
      font-size: 12px;
      max-width: 100vw;
      overflow-x: hidden;
    }

    table th,
    table td {
      padding: 2px !important;
    }

    .compact-input {
      padding: 2px !important;
      font-size: 12px !important;
    }

    html {
      font-size: 14px;
    }
    @media (min-width: 1024px) {
      html { font-size: 16px; }
    }
  </style>
</head>

<body class="bg-gray-50 p-4">
  <div id="root"></div>

  <script type="text/babel">

    /* --------------------------------------------------------
       CLEAN UPDATED ARRAYS
    -------------------------------------------------------- */

    const DISEASES = [
      "Botrytis (Gray Mold)",
      "Powdery Mildew",
      "Downy Mildew",
      "Rust",
      "Leaf Spot Diseases",
      "Root Rot Diseases"
    ];

    const PESTS = [
      "Aphids",
      "Mites",
      "Thrips",
      "White Flies",
      "Japanese Beetles",
      "Lepidoptera",
      "Fungus Gnats",
      "Mealy Bugs"
    ];

    const WEED_MANAGEMENT = [
      "Pre-emergent",
      "Post-emergent",
      "Lichens",
      "Liverwort",
      "Algae",
      "Moss"
    ];

    const PPE_ITEMS = [
      "Respirator/Mask",
      "Suit",
      "Long Sleeves/Pants",
      "Boots",
      "Face Shield",
      "Gloves",
      "Protective Eyewear"
    ];

    const DEFAULT_APPLICATORS = ["Jacob Imel #154583"];
    const DEFAULT_METHODS = ["Foliar", "Drench", "Broadcast", "Spot Treatment", "Drone"];

    /* --------------------------------------------------------
       MAIN COMPONENT
    -------------------------------------------------------- */
    function SprayPlanBuilder() {

      const [chemicalOptions, setChemicalOptions] = React.useState([]);
      const [applicators, setApplicators] = React.useState(DEFAULT_APPLICATORS);
      const [selectedChems, setSelectedChems] = React.useState(["", "", "", ""]);
      const [applicator, setApplicator] = React.useState("");
      const [method, setMethod] = React.useState("");
      const [error, setError] = React.useState("");

      const chemicalSheetUrl =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZfyqtPqy898TcyxUzKJzSoOZNj-8qYXs3nRzfbI_tA2qZCaVqiQwz4fgO_jWZ4lF7Rr-a29LxiEw7/pub?output=csv";

      const applicatorSheetUrl =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZfyqtPqy898TcyxUzKJzSoOZNj-8qYXs3nRzfbI_tA2qZCaVqiQwz4fgO_jWZ4lF7Rr-a29LxiEw7/pub?gid=1594882491&single=true&output=csv";

      React.useEffect(() => {
        fetch(chemicalSheetUrl)
          .then(res => res.text())
          .then(parseChemicalCSV)
          .catch(() => setError("Unable to fetch chemical sheet â€” upload CSV manually."));

        fetch(applicatorSheetUrl)
          .then(res => res.text())
          .then(parseApplicatorCSV)
          .catch(() => {});
      }, []);

      /* --------------------------------------------------------
         PARSE CHEMICAL CSV
      -------------------------------------------------------- */
      function parseChemicalCSV(data) {
        const parsed = Papa.parse(data, {
          header: true,
          skipEmptyLines: true,
          transformHeader: (header) =>
            header.replace(/\uFEFF/g, "").replace(/\u00A0/g, " ").trim().toLowerCase()
        });

        const chemicals = parsed.data
          .map(row => {
            const clean = {};
            for (let k in row) clean[k.toLowerCase().trim()] = (row[k] || "").trim();

            return {
              chemical: clean["chemical"],
              measurement: clean["measurement"],
              epaReg: clean["epa reg #"],
              wales: clean["wales"],
              warn: clean["warnings/ notes"],
              ai: clean["ai"],
              moA: clean["moa"],
              rei: clean["rei"],
              function: clean["function"],
              stage: clean["stage active"],
              irac: clean["chemical class"],
              signal: clean["signal word"],
              mask: clean["mask needed"]
            };
          })
          .filter(c => c.chemical);

        setChemicalOptions(chemicals);
      }

      /* --------------------------------------------------------
         PARSE APPLICATORS
      -------------------------------------------------------- */
      function parseApplicatorCSV(data) {
        const rows = data.split(/\r?\n/).filter(r => r.trim());
        const parsed = rows.map(r => r.split(","));
        const list = parsed.slice(1).map(cols => cols[cols.length - 1]?.trim());
        if (list.length) setApplicators(list);
      }

      /* --------------------------------------------------------
         FILE UPLOAD
      -------------------------------------------------------- */
      const handleCSVUpload = e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => parseChemicalCSV(e.target.result);
        reader.readAsText(file);
      };

      /* --------------------------------------------------------
         RENDER
      -------------------------------------------------------- */
      return (
        <div className="space-y-4 max-w-4xl mx-auto">

          {/* HEADER */}
          <div className="flex items-center gap-3">
            <img src="GardensAliveLogo.png" className="h-16" />
            <h1 className="text-2xl font-bold">Spray Plan</h1>
          </div>

          {error && (
            <div className="bg-red-200 text-red-900 p-2 rounded">
              {error}
              <input type="file" accept=".csv" onChange={handleCSVUpload} className="mt-1" />
            </div>
          )}

          <button className="bg-blue-500 text-white px-3 py-1 rounded" onClick={() => window.print()}>
            Print / Save PDF
          </button>

          {/* TOP FORM */}
          <div className="grid grid-cols-2 gap-2">
            <div>
              <label className="text-xs">Date & Time</label>
              <input type="datetime-local" className="w-full border compact-input rounded" />
            </div>

            <div>
              <label className="text-xs">Area Treated</label>
              <input type="text" className="w-full border compact-input rounded" />
            </div>

            <div>
              <label className="text-xs">Applicator</label>
              <select className="w-full border compact-input rounded" value={applicator}
                onChange={e => setApplicator(e.target.value)}>
                <option value="">Select Applicator...</option>
                {applicators.map(a => <option key={a}>{a}</option>)}
              </select>
            </div>

            <div>
              <label className="text-xs">Method</label>
              <select className="w-full border compact-input rounded" value={method}
                onChange={e => setMethod(e.target.value)}>
                <option value="">Select Method...</option>
                {DEFAULT_METHODS.map(m => <option key={m}>{m}</option>)}
              </select>
            </div>
          </div>

          {/* CHEMICALS */}
          <h2 className="font-semibold mt-2 text-sm">Chemicals Applied</h2>
          <table className="w-full border text-xs">
            <thead className="bg-gray-200">
              <tr>
                <th className="border">Chemical</th>
                <th className="border">EPA #</th>
                <th className="border">AI</th>
                <th className="border">REI</th>
                <th className="border">MoA</th>
              </tr>
            </thead>

            <tbody>
              {selectedChems.map((chem, i) => {
                const full = chemicalOptions.find(c => c.chemical === chem);
                return (
                  <tr key={i}>
                    <td className="border">
                      <select className="w-full border compact-input rounded"
                        value={chem}
                        onChange={e => {
                          const copy = [...selectedChems];
                          copy[i] = e.target.value;
                          setSelectedChems(copy);
                        }}>
                        <option value="">Select...</option>
                        {chemicalOptions.map(c =>
                          <option key={c.chemical} value={c.chemical}>{c.chemical}</option>
                        )}
                      </select>
                    </td>
                    <td className="border">{full?.epaReg}</td>
                    <td className="border">{full?.ai}</td>
                    <td className="border">{full?.rei}</td>
                    <td className="border">{full?.moA}</td>
                  </tr>
                );
              })}
            </tbody>
          </table>

          {/* SAFETY INFO */}
          <h2 className="font-semibold mt-2 text-sm">Chemical Safety Information</h2>

          <div className="text-xs font-semibold">
            Signal Word (Most Restrictive):{" "}
            <span className="font-bold">
              {(() => {
                const words = selectedChems
                  .map(c => chemicalOptions.find(x => x.chemical === c)?.signal || "")
                  .filter(Boolean);
                if (words.includes("DANGER")) return "DANGER";
                if (words.includes("WARNING")) return "WARNING";
                if (words.includes("CAUTION")) return "CAUTION";
                return "N/A";
              })()}
            </span>
          </div>

          <table className="w-full border text-xs">
            <thead className="bg-gray-200">
              <tr>
                <th className="border">Function</th>
                <th className="border">Measurement</th>
                <th className="border">Stage Active</th>
                <th className="border">Warnings / Notes</th>
                <th className="border">WALES</th>
              </tr>
            </thead>

            <tbody>
              {selectedChems.map((chem, i) => {
                const full = chemicalOptions.find(c => c.chemical === chem);
                return (
                  <tr key={i}>
                    <td className="border">{full?.function || full?.moA}</td>
                    <td className="border">{full?.measurement}</td>
                    <td className="border">{full?.stage}</td>
                    <td className="border">{full?.warn}</td>
                    <td className="border">{full?.wales}</td>
                  </tr>
                );
              })}
            </tbody>
          </table>

          {/* PESTS, DISEASES, WEED MGMT, PPE */}
          <h2 className="font-semibold mt-2 text-sm">Pests, Diseases & PPE</h2>

          <div className="grid grid-cols-4 gap-4">

            {/* PESTS */}
            <div>
              <h4 className="font-semibold underline text-xs mb-1">Pests</h4>
              <div className="flex flex-col gap-1 text-xs">
                {PESTS.map(item => (
                  <label key={item} className="flex items-center">
                    <input type="checkbox" className="mr-1" /> {item}
                  </label>
                ))}
              </div>
            </div>

            {/* DISEASES */}
            <div>
              <h4 className="font-semibold underline text-xs mb-1">Diseases</h4>
              <div className="flex flex-col gap-1 text-xs">
                {DISEASES.map(item => (
                  <label key={item} className="flex items-center">
                    <input type="checkbox" className="mr-1" /> {item}
                  </label>
                ))}
              </div>
            </div>

            {/* WEED MANAGEMENT */}
            <div>
              <h4 className="font-semibold underline text-xs mb-1">Weed Management</h4>
              <div className="flex flex-col gap-1 text-xs">
                {WEED_MANAGEMENT.map(item => (
                  <label key={item} className="flex items-center">
                    <input type="checkbox" className="mr-1" /> {item}
                  </label>
                ))}
              </div>
            </div>

            {/* PPE */}
            <div>
              <h4 className="font-semibold text-xs mb-1 ml-4">Required PPE</h4>
              <div className="flex flex-col gap-1 text-xs ml-4">
                {PPE_ITEMS.map(item => {
                  const needsMask = selectedChems.some(c => {
                    const f = chemicalOptions.find(x => x.chemical === c);
                    return f?.mask?.toLowerCase() === "mask";
                  });
                  const isMask = item === "Respirator/Mask";

                  return (
                    <label key={item} className="flex items-center">
                      <input
                        type="checkbox"
                        className="mr-1"
                        checked={isMask ? needsMask : undefined}
                        onChange={() => {}}
                      />
                      {item}
                    </label>
                  );
                })}
              </div>
            </div>

          </div>

          {/* EMERGENCY */}
          <div className="border-t pt-3 mt-4">
            <h2 className="font-bold text-sm mb-1">Emergency Information</h2>
            <div className="border p-2 rounded bg-red-50 text-xs">
              <p><strong>In an emergency, contact:</strong> 911</p>
              <p><strong>Poison Control:</strong> 222-2227</p>
            </div>
          </div>

          {/* TOTAL SPRAYED */}
          <h2 className="font-semibold text-sm mt-3">Total Amount Sprayed</h2>
          <input type="text" className="w-full border rounded p-2 compact-input"
            placeholder="Enter total volume applied (e.g. 25 gallons)" />

          {/* WHAT WAS TREATED */}
          <h2 className="font-semibold text-sm mt-3">What Was Treated</h2>
          <textarea className="w-full border rounded p-2 compact-input" rows="2"
            placeholder="Enter crop, block, or greenhouse zones treated..."></textarea>

        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<SprayPlanBuilder />);

  </script>
</body>
</html>



















